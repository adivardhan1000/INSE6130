#!/usr/bin/env python3

import subprocess

try:
	# Get runc version
	cmd = "dpkg -l runc | grep -E '^ii\s+runc\s+'"
	runc_version = subprocess.check_output(cmd, shell=True).decode().split()[2].split("+")[0].split("~")
	print(runc_version)
	#runc_version = runc_version.split("-")[0]
	# Check if runc version is vulnerable
	if runc_version[0] == '1.0.0' and runc_version[1] <= 'rc95':
		print(f"Your version of runc ({runc_version}) is vulnerable.")
		if input("Do you want to upgrade to fix?(y/n)").strip().lower() == "y":
			# Upgrade runc to the latest version
			cmd = "yes | sudo apt install --reinstall libappstream4 && \
				yes | sudo apt remove runc && \
				yes | sudo apt update && \
				yes | sudo apt install -y runc"
			subprocess.run(cmd, shell=True)
			print("runc upgraded to the latest version.")

			# upgrade docker to the latest version
			cmd = "yes | sudo apt install apt-transport-https ca-certificates curl software-properties-common && \
				yes | curl -fsSL https://download.docker.com/linux/ubuntu/gpg | sudo apt-key add -  && \
				yes | sudo add-apt-repository 'deb [arch=amd64] https://download.docker.com/linux/ubuntu bionic stable'"
			subprocess.run(cmd, shell=True)
			get_versions = "yes | sudo apt-get update && apt-cache madison docker-ce | awk '{ print $3 }'"
			output = subprocess.check_output(get_versions, shell=True).decode()
			version = ""
			for line in output.split("\n"):
				if '18.09.4' in line:
					version = line
					break
			print(version)
			bump = "VERSION_STRING=" + version + " && yes | sudo apt-get install docker-ce=$VERSION_STRING docker-ce-cli=$VERSION_STRING containerd.io docker-buildx-plugin docker-compose-plugin"
			subprocess.run(bump, shell=True)
			subprocess.run(cmd, shell=True)
			#print("Docker version upgraded to "+output)
	else:
		print(f"Your version of runc is not vulnerable.")

except subprocess.CalledProcessError as e:
	print("runc is not installed.")
    # Handle non-zero exit status
	print("Error: ", e.output.decode())
